<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Money Notebook Pro</title>
  
  <!-- Premium Font -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <!-- Chart & Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* --- Core Variables & Reset --- */
    :root {
      --bg-color: #050505;
      --surface: rgba(255, 255, 255, 0.03);
      --surface-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-muted: #8a8f98;
      --accent: #00e5ff;
      --accent-glow: rgba(0, 229, 255, 0.3);
      --success: #00ff88;
      --success-glow: rgba(0, 255, 136, 0.2);
      --danger: #ff3366;
      --danger-glow: rgba(255, 51, 102, 0.2);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Outfit', sans-serif;
      background: radial-gradient(circle at top left, #120e2a, var(--bg-color) 40%),
                  radial-gradient(circle at bottom right, #091221, var(--bg-color) 40%);
      color: var(--text-main);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* --- Animations --- */
    @keyframes slideUpFade {
      0% { opacity: 0; transform: translateY(30px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 15px var(--danger-glow); }
      50% { box-shadow: 0 0 25px rgba(255, 51, 102, 0.5); }
    }

    /* --- Layout & Glassmorphism --- */
    .container {
      max-width: 760px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .glass-card {
      background: var(--surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--surface-border);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: popIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* --- Header & Hero --- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      animation: slideUpFade 0.5s ease-out;
    }
    .logo {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, #fff, var(--text-muted));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .hero-balance {
      text-align: center;
      margin-bottom: 40px;
      animation: slideUpFade 0.7s ease-out forwards;
    }
    .hero-balance p {
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .hero-balance h1 {
      font-size: 56px;
      font-weight: 700;
      text-shadow: 0 4px 20px rgba(255,255,255,0.1);
      letter-spacing: -2px;
    }

    /* --- Progress Widgets --- */
    .limits-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 30px;
    }
    .limit-widget {
      display: none; /* Hidden if 0 */
      flex-direction: column;
      gap: 8px;
    }
    .limit-header {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 600;
    }
    .limit-header span.val { color: var(--text-main); }
    .progress-track {
      height: 8px;
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #00b4d8);
      width: 0%;
      border-radius: 8px;
      transition: width 1s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s;
      box-shadow: 0 0 10px var(--accent-glow);
    }
    .progress-fill.danger {
      background: linear-gradient(90deg, #ff416c, var(--danger));
      box-shadow: 0 0 15px var(--danger-glow);
    }
    .limit-warning {
      color: var(--danger);
      font-size: 12px;
      font-weight: 600;
      display: none;
      animation: popIn 0.3s ease;
    }

    /* --- Input Form --- */
    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    @media(max-width: 600px) { .input-grid { grid-template-columns: 1fr; } }
    
    .input-group { position: relative; }
    .input-group input, .input-group select {
      width: 100%;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--surface-border);
      padding: 16px 16px 16px 45px;
      border-radius: 12px;
      color: white;
      font-family: inherit;
      font-size: 15px;
      transition: all 0.3s ease;
    }
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
      background: rgba(0,0,0,0.4);
    }
    .input-group i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      pointer-events: none;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .btn {
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .btn-spend {
      background: rgba(255, 51, 102, 0.1);
      color: var(--danger);
      border: 1px solid rgba(255, 51, 102, 0.2);
    }
    .btn-spend:hover {
      background: var(--danger);
      color: white;
      box-shadow: 0 8px 20px var(--danger-glow);
      transform: translateY(-2px);
    }
    .btn-reserve {
      background: rgba(0, 255, 136, 0.1);
      color: var(--success);
      border: 1px solid rgba(0, 255, 136, 0.2);
    }
    .btn-reserve:hover {
      background: var(--success);
      color: #000;
      box-shadow: 0 8px 20px var(--success-glow);
      transform: translateY(-2px);
    }

    /* --- Transactions --- */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 40px 0 20px;
    }
    .toolbar h3 { font-size: 20px; font-weight: 600; }
    .search-box {
      position: relative;
      width: 200px;
    }
    .search-box input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--surface-border);
      padding: 8px 16px 8px 36px;
      border-radius: 20px;
      color: white;
      font-size: 13px;
      transition: all 0.3s;
    }
    .search-box input:focus { width: 250px; border-color: var(--accent); outline: none; }
    .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 12px; color: var(--text-muted); }

    .day-group {
      margin-bottom: 24px;
      animation: slideUpFade 0.5s ease-out backwards;
    }
    .day-header {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      padding: 0 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .tx-item {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--surface-border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
    }
    .tx-item:hover {
      background: rgba(255,255,255,0.05);
      transform: translateX(5px);
    }
    .tx-left { display: flex; align-items: center; gap: 16px; }
    .tx-icon {
      width: 44px; height: 44px;
      border-radius: 12px;
      display: flex; justify-content: center; align-items: center;
      font-size: 20px;
    }
    .tx-spend .tx-icon { background: rgba(255, 51, 102, 0.1); }
    .tx-reserve .tx-icon { background: rgba(0, 255, 136, 0.1); }
    
    .tx-meta h4 { font-size: 16px; font-weight: 500; margin-bottom: 2px; }
    .tx-meta p { font-size: 12px; color: var(--text-muted); }
    
    .tx-right { display: flex; align-items: center; gap: 15px; }
    .tx-amount { font-size: 16px; font-weight: 700; }
    .tx-spend .tx-amount { color: var(--danger); }
    .tx-reserve .tx-amount { color: var(--success); }
    
    .btn-delete {
      background: none; border: none;
      color: var(--text-muted);
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s;
      padding: 8px;
    }
    .tx-item:hover .btn-delete { opacity: 1; color: var(--danger); }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state div { font-size: 48px; margin-bottom: 15px; opacity: 0.5; animation: float 6s infinite ease-in-out; }

    /* --- Chart Area --- */
    .chart-wrapper {
      margin-top: 40px;
      height: 300px;
      display: none;
    }

    /* --- Controls & Modals --- */
    .icon-btn {
      background: var(--surface);
      border: 1px solid var(--surface-border);
      color: white;
      width: 40px; height: 40px;
      border-radius: 12px;
      display: flex; justify-content: center; align-items: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.05); }

    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      z-index: 2000;
      display: none;
      justify-content: center; align-items: center;
      animation: fadeIn 0.3s;
    }
    .modal-content {
      width: 90%; max-width: 400px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .modal-content h2 { margin-bottom: 20px; font-size: 20px; }
    
    /* --- Toasts --- */
    .toast-container {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; flex-direction: column; gap: 10px; z-index: 9999;
    }
    .toast {
      background: rgba(20, 20, 25, 0.95);
      backdrop-filter: blur(10px);
      color: #fff;
      padding: 14px 24px;
      border-radius: 100px;
      font-size: 14px; font-weight: 500;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid var(--surface-border);
      animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      display: flex; align-items: center; gap: 10px;
    }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.fade-out { animation: popIn 0.3s reverse forwards; opacity: 0;}

    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
  </style>
</head>
<body>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="glass-card modal-content">
      <h2>‚öôÔ∏è Limits & Alerts</h2>
      
      <div class="input-grid" style="grid-template-columns: 1fr; gap: 12px; margin-bottom: 24px;">
        <div class="input-group">
          <i>üìÖ</i>
          <input type="number" id="modalMonthlyLimit" placeholder="Monthly Limit (‚Çπ)" min="0">
        </div>
        <div class="input-group">
          <i>‚òÄÔ∏è</i>
          <input type="number" id="modalDailyLimit" placeholder="Daily Limit (‚Çπ)" min="0">
        </div>
        <div class="input-group">
          <i>üîî</i>
          <input type="time" id="modalReminderTime" title="Daily Notification Time">
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn" style="background: rgba(255,255,255,0.05); color: white;" onclick="closeSettings()">Cancel</button>
        <button class="btn" style="background: var(--text-main); color: #000;" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <div class="container">
    
    <header>
      <div class="logo">MoneyNotebook.</div>
      <div style="display: flex; gap: 10px;">
        <button class="icon-btn" onclick="scrollToGraph()" title="View Chart">üìä</button>
        <button class="icon-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
      </div>
    </header>

    <!-- Animated Hero Balance -->
    <div class="hero-balance">
      <p>Total Balance</p>
      <h1 id="totalBalanceDisplay">‚Çπ0</h1>
    </div>

    <!-- Glowing Progress Limits -->
    <div class="limits-grid">
      <div id="monthlyProgressContainer" class="glass-card limit-widget">
        <div class="limit-header">
          <span>Monthly</span>
          <span class="val" id="monthlyText">‚Çπ0 / ‚Çπ0</span>
        </div>
        <div class="progress-track"><div id="monthlyBar" class="progress-fill"></div></div>
        <div id="monthlyWarning" class="limit-warning">‚ö†Ô∏è Over by ‚Çπ<span id="monthlyOverAmt"></span></div>
      </div>
      
      <div id="dailyProgressContainer" class="glass-card limit-widget">
        <div class="limit-header">
          <span>Daily</span>
          <span class="val" id="dailyText">‚Çπ0 / ‚Çπ0</span>
        </div>
        <div class="progress-track"><div id="dailyBar" class="progress-fill"></div></div>
        <div id="dailyWarning" class="limit-warning">‚ö†Ô∏è Over by ‚Çπ<span id="dailyOverAmt"></span></div>
      </div>
    </div>

    <!-- Action Form -->
    <div class="glass-card">
      <div class="input-grid">
        <div class="input-group">
          <i>‚Çπ</i>
          <input type="number" id="amount" placeholder="Amount" min="0" step="any">
        </div>
        <div class="input-group">
          <i>üìù</i>
          <input type="text" id="reason" placeholder="What was this for?">
        </div>
        <div class="input-group">
          <i>üè∑Ô∏è</i>
          <select id="category">
            <option value="nil">Select Category...</option>
            <option value="Food">Food</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Bills">Bills</option>
            <option value="Savings">Savings</option>
            <option value="Travel">Travel</option>
            <option value="Shopping">Shopping</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="input-group">
          <i>üìÖ</i>
          <input type="date" id="date" style="color-scheme: dark;">
        </div>
      </div>
      <div class="action-buttons">
        <button id="spendBtn" class="btn btn-spend">‚Üì Spend</button>
        <button id="reserveBtn" class="btn btn-reserve">‚Üë Reserve</button>
      </div>
    </div>

    <!-- Chart -->
    <div class="glass-card chart-wrapper" id="chartWrapper">
      <canvas id="expenseChart"></canvas>
    </div>

    <!-- Transaction List Area -->
    <div class="toolbar">
      <h3>Recent Activity</h3>
      <div class="search-box">
        <i>üîç</i>
        <input type="text" id="searchInput" placeholder="Search..." oninput="filterTransactions()">
      </div>
    </div>

    <div id="months"></div>

  </div>

  <script>
    // --- Configuration & Elements ---
    const catMap = { 'Food':'üçî', 'Entertainment':'üé¨', 'Bills':'üßæ', 'Savings':'üè¶', 'Travel':'‚úàÔ∏è', 'Shopping':'üõçÔ∏è', 'Other':'üì¶', 'nil':'‚ú®' };
    const els = {
      amount: document.getElementById('amount'),
      reason: document.getElementById('reason'),
      category: document.getElementById('category'),
      date: document.getElementById('date'),
      search: document.getElementById('searchInput'),
      list: document.getElementById('months'),
      balance: document.getElementById('totalBalanceDisplay'),
      chart: document.getElementById('chartWrapper'),
      toast: document.getElementById('toastContainer')
    };
    const ctx = document.getElementById('expenseChart').getContext('2d');
    let expenseChart, cachedTransactions = [], currentBalance = 0;

    // Set default date
    els.date.value = new Date().toISOString().split('T')[0];

    // Settings
    let currentMonthlyLimit = parseFloat(localStorage.getItem('mn_monthlyLimit')) || 0;
    let currentDailyLimit = parseFloat(localStorage.getItem('mn_dailyLimit')) || 0;
    let dailyReminderTime = localStorage.getItem('mn_reminderTime') || '';
    let reminderIntervalId = null;

    // --- Core Utilities ---
    const showToast = (msg, type = 'info') => {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `${type==='success'?'‚úÖ':type==='error'?'‚ö†Ô∏è':'‚ÑπÔ∏è'} ${msg}`;
      els.toast.appendChild(t);
      setTimeout(() => { t.classList.add('fade-out'); setTimeout(()=>t.remove(), 300); }, 3000);
    };

    const animateValue = (obj, start, end, duration) => {
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const current = progress * (end - start) + start;
        obj.innerHTML = `‚Çπ${current.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
        if (progress < 1) window.requestAnimationFrame(step);
        else obj.innerHTML = `‚Çπ${end.toLocaleString('en-IN', {maximumFractionDigits: 2})}`; // final exact
      };
      window.requestAnimationFrame(step);
    };

    // --- DB Wrapper ---
    const dbWrapper = {
      dbName: 'MoneyNotebookMVP', version: 1, storeName: 'txs', db: null,
      init: () => new Promise((res, rej) => {
        const req = indexedDB.open(dbWrapper.dbName, dbWrapper.version);
        req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(dbWrapper.storeName)) e.target.result.createObjectStore(dbWrapper.storeName, { keyPath: 'id', autoIncrement: true }); };
        req.onsuccess = e => { dbWrapper.db = e.target.result; res(); };
        req.onerror = e => rej(e.target.error);
      }),
      getAll: () => new Promise((res, rej) => {
        const req = dbWrapper.db.transaction([dbWrapper.storeName], 'readonly').objectStore(dbWrapper.storeName).getAll();
        req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error);
      }),
      add: (data) => new Promise((res, rej) => {
        const req = dbWrapper.db.transaction([dbWrapper.storeName], 'readwrite').objectStore(dbWrapper.storeName).add(data);
        req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error);
      }),
      delete: (id) => new Promise((res, rej) => {
        const req = dbWrapper.db.transaction([dbWrapper.storeName], 'readwrite').objectStore(dbWrapper.storeName).delete(id);
        req.onsuccess = () => res(); req.onerror = () => rej(req.error);
      })
    };

    // --- Core Logic ---
    async function loadTransactions() {
      cachedTransactions = await dbWrapper.getAll();
      
      const newBalance = cachedTransactions.reduce((acc, t) => acc + t.amount, 0);
      if(newBalance !== currentBalance) {
        animateValue(els.balance, currentBalance, newBalance, 1000);
        currentBalance = newBalance;
      } else {
        els.balance.innerHTML = `‚Çπ${currentBalance.toLocaleString('en-IN', {maximumFractionDigits: 2})}`;
      }

      renderTransactions(cachedTransactions);
      renderChart(cachedTransactions);
      updateLimits();
    }

    async function handleTransaction(isReserve) {
      const amt = parseFloat(els.amount.value);
      const rsn = els.reason.value.trim();
      const cat = els.category.value;
      const dte = els.date.value || new Date().toISOString().split('T')[0];
      
      if(isNaN(amt) || amt <= 0 || !rsn || cat === 'nil') return showToast('Fill all fields correctly.', 'error');

      const now = new Date();
      await dbWrapper.add({
        date: dte, amount: isReserve ? amt : -amt, reason: rsn, category: cat,
        time: `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`
      });

      showToast(isReserve ? 'Reserves added!' : 'Expense recorded!', 'success');
      if (isReserve) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors:['#00ff88','#ffffff'] });
      
      els.amount.value = ''; els.reason.value = ''; els.category.value = 'nil';
      loadTransactions();
    }

    async function deleteTransaction(id) {
      await dbWrapper.delete(id);
      showToast('Deleted', 'info');
      loadTransactions();
    }

    // --- Rendering ---
    function renderTransactions(data) {
      const filter = els.search.value.toLowerCase().trim();
      els.list.innerHTML = '';
      
      const filtered = data.filter(t => !filter || `${t.reason} ${t.category} ${t.amount}`.toLowerCase().includes(filter));
      if(filtered.length === 0) {
        els.list.innerHTML = `<div class="empty-state"><div>üçÉ</div><p>No activity found.</p></div>`;
        return;
      }

      const grouped = filtered.reduce((acc, t) => {
        const d = new Intl.DateTimeFormat('en-GB', { day:'2-digit', month:'short', year:'numeric'}).format(new Date(t.date));
        if(!acc[d]) acc[d] = []; acc[d].push(t); return acc;
      }, {});

      let delay = 0;
      Object.keys(grouped).sort((a,b)=>new Date(b)-new Date(a)).forEach(day => {
        const dayTotal = grouped[day].reduce((sum, t) => sum + t.amount, 0);
        const grpEl = document.createElement('div');
        grpEl.className = 'day-group';
        grpEl.style.animationDelay = `${delay}s`; delay += 0.1;
        
        let txHTML = grouped[day].sort((a,b)=>b.id-a.id).map(t => {
          const isSpend = t.amount < 0;
          return `
            <div class="tx-item ${isSpend ? 'tx-spend' : 'tx-reserve'}">
              <div class="tx-left">
                <div class="tx-icon">${catMap[t.category] || '‚ú®'}</div>
                <div class="tx-meta">
                  <h4>${t.reason}</h4>
                  <p>${t.category} ‚Ä¢ ${t.time || ''}</p>
                </div>
              </div>
              <div class="tx-right">
                <span class="tx-amount">${isSpend?'-':'+'}‚Çπ${Math.abs(t.amount).toLocaleString('en-IN')}</span>
                <button class="btn-delete" onclick="deleteTransaction(${t.id})">‚úñ</button>
              </div>
            </div>`;
        }).join('');

        grpEl.innerHTML = `
          <div class="day-header"><span>${day}</span><span>‚Çπ${dayTotal.toLocaleString('en-IN')}</span></div>
          ${txHTML}
        `;
        els.list.appendChild(grpEl);
      });
    }

    function renderChart(data) {
      const exp = data.filter(t => t.amount < 0);
      if(!exp.length) { els.chart.style.display = 'none'; return; }
      
      els.chart.style.display = 'block';
      const cats = [...new Set(exp.map(t=>t.category))];
      const cData = cats.map(c => exp.filter(t=>t.category===c).reduce((s,t)=>s+Math.abs(t.amount),0));
      
      if(expenseChart) expenseChart.destroy();
      expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: cats, datasets: [{ data: cData, backgroundColor: ['#00e5ff','#ff3366','#00ff88','#ffd700','#bb86fc','#ff9800'], borderWidth: 0, hoverOffset: 10 }] },
        options: {
          responsive: true, maintainAspectRatio: false, cutout: '80%',
          plugins: {
            legend: { position: 'right', labels: { color: '#8a8f98', font: { family: 'Outfit', size: 13 } } },
            tooltip: { backgroundColor: 'rgba(20,20,25,0.9)', titleColor: '#fff', bodyColor: '#00e5ff', padding: 12, borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1 }
          }
        }
      });
    }

    function updateLimits() {
      const now = new Date();
      const currMo = now.getMonth(), currYr = now.getFullYear(), today = now.toISOString().split('T')[0];

      const updateWidget = (type, limit, spends) => {
        const cont = document.getElementById(`${type}ProgressContainer`);
        if(!limit) { cont.style.display = 'none'; return; }
        cont.style.display = 'flex';
        
        const pct = Math.min((spends/limit)*100, 100);
        const isOver = spends > limit;
        document.getElementById(`${type}Text`).innerText = `‚Çπ${spends.toLocaleString('en-IN')} / ‚Çπ${limit.toLocaleString('en-IN')}`;
        const bar = document.getElementById(`${type}Bar`);
        bar.style.width = `${pct}%`;
        
        const warn = document.getElementById(`${type}Warning`);
        if(isOver) { bar.classList.add('danger'); warn.style.display = 'block'; document.getElementById(`${type}OverAmt`).innerText = (spends-limit).toLocaleString('en-IN'); }
        else { bar.classList.remove('danger'); warn.style.display = 'none'; }
      };

      const moSpends = cachedTransactions.filter(t => t.amount < 0 && new Date(t.date).getMonth()===currMo && new Date(t.date).getFullYear()===currYr).reduce((s,t)=>s+Math.abs(t.amount),0);
      updateWidget('monthly', currentMonthlyLimit, moSpends);

      const daSpends = cachedTransactions.filter(t => t.amount < 0 && t.date === today).reduce((s,t)=>s+Math.abs(t.amount),0);
      updateWidget('daily', currentDailyLimit, daSpends);
    }

    // --- Settings & Reminders ---
    function openSettings() {
      document.getElementById('modalMonthlyLimit').value = currentMonthlyLimit || '';
      document.getElementById('modalDailyLimit').value = currentDailyLimit || '';
      document.getElementById('modalReminderTime').value = dailyReminderTime;
      document.getElementById('settingsModal').style.display = 'flex';
    }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function saveSettings() {
      currentMonthlyLimit = parseFloat(document.getElementById('modalMonthlyLimit').value) || 0;
      currentDailyLimit = parseFloat(document.getElementById('modalDailyLimit').value) || 0;
      dailyReminderTime = document.getElementById('modalReminderTime').value;
      
      localStorage.setItem('mn_monthlyLimit', currentMonthlyLimit);
      localStorage.setItem('mn_dailyLimit', currentDailyLimit);
      if(dailyReminderTime) {
        localStorage.setItem('mn_reminderTime', dailyReminderTime);
        if ('Notification' in window && Notification.permission !== 'granted') Notification.requestPermission();
      } else localStorage.removeItem('mn_reminderTime');

      updateLimits(); closeSettings(); showToast('Settings Updated', 'success');
      if(reminderIntervalId) clearInterval(reminderIntervalId);
      if(dailyReminderTime) reminderIntervalId = setInterval(checkReminder, 60000);
    }
    
    function checkReminder() {
      const now = new Date();
      if (`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}` === dailyReminderTime) {
        const today = now.toISOString().split('T')[0];
        if(localStorage.getItem('mn_lastNotified') !== today && 'Notification' in window && Notification.permission === 'granted') {
          new Notification("Money Notebook", { body: "Time to log your daily expenses!" });
          localStorage.setItem('mn_lastNotified', today);
        }
      }
    }

    // --- Init ---
    document.getElementById('spendBtn').onclick = () => handleTransaction(false);
    document.getElementById('reserveBtn').onclick = () => handleTransaction(true);
    window.filterTransactions = () => renderTransactions(cachedTransactions);
    window.scrollToGraph = () => { if(els.chart.style.display !== 'none') els.chart.scrollIntoView({behavior:'smooth'}); else showToast('No data to chart yet!'); };

    document.addEventListener('DOMContentLoaded', async () => {
      await dbWrapper.init();
      loadTransactions();
      if(dailyReminderTime) reminderIntervalId = setInterval(checkReminder, 60000);
    });
  </script>
</body>
</html>


